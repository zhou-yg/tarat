import { IHookContext, setHookAdaptor, setModelConfig } from '@tarot-run/core'
import React, { createElement } from 'react'
import { createRoot } from 'react-dom/client'
import Page from '<%= resolutionId %>';


setHookAdaptor(React, 'react')

render(Page)

const hostConfig = `/${window.tarotConfig?.apiPre || '_hook'}`
const diffPath = `/${window.tarotConfig?.diffPath || '_diff'}`

/**
 * @TODO should provide by @tarot-run by default
 */
setModelConfig({
  async find(e, w) {
    return []
  },
  async update(e, w) {
    return []
  },
  async remove(e, d) {
    return []
  },
  async create(e, d) {
    return {}
  },
  async executeDiff(d) {},
  async postDiffToServer(entity, diff) {
    await fetch(`${diffPath}`, {
      method: 'POST',
      body: JSON.stringify({
        entity,
        diff
      })
    })
  },
  async postComputeToServer(c) {

    const newContext = await fetch(`${hostConfig}/${c.name}`, {
      method: 'POST',
      body: JSON.stringify(c)
    }).then(r => r.json())

    return newContext
  },
  async postQueryToServer(c) {
    console.log('postQueryToServer: ');
    const newContext = await fetch(`${hostConfig}/${c.name}`, {
      method: 'POST',
      body: JSON.stringify(c)
    }).then(r => r.json())

    return newContext
  }
})


function render (f) {

  const ele = createElement(f)

  const app = createRoot(document.getElementById('<%= mountedAppId %>'))
  app.render(ele)
}
